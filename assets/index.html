<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHousekeeper</title>
    <style>
      :root {
        --bg-color: #1e1e2e;
        --sidebar-color: #181825;
        --text-color: #cdd6f4;
        --accent-color: #a6e3a1; /* Green */
        --accent-hover: #94e2d5;
        --input-bg: #313244;
        --border-color: #45475a;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: 250px;
        background-color: var(--sidebar-color);
        display: flex;
        flex-direction: column;
        padding: 20px;
        border-right: 1px solid var(--border-color);
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        color: var(--accent-color);
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .nav-item {
        padding: 12px 15px;
        margin-bottom: 5px;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s;
        color: #a6adc8;
      }

      .nav-item:hover {
        background-color: #313244;
        color: var(--text-color);
      }

      .nav-item.active {
        background-color: var(--accent-color);
        color: var(--sidebar-color);
        font-weight: bold;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        padding: 40px;
        overflow-y: auto;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h2 {
        margin-top: 0;
        margin-bottom: 30px;
        font-size: 28px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
      }

      /* Forms */
      .form-group {
        margin-bottom: 25px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
      }

      input[type="text"],
      textarea,
      select {
        width: 100%;
        padding: 12px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        font-family: inherit;
        box-sizing: border-box;
        transition: border-color 0.2s;
      }

      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      .hint {
        font-size: 12px;
        color: #a6adc8;
        margin-top: 5px;
      }

      /* Dynamic Lists */
      .replacement-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: opacity 0.2s;
      }

      .btn-primary {
        background-color: var(--accent-color);
        color: var(--sidebar-color);
      }

      .btn-secondary {
        background-color: var(--input-bg);
        color: var(--text-color);
      }

      .btn:hover {
        opacity: 0.9;
      }

      .btn-add {
        width: 100%;
        margin-top: 10px;
        border: 1px dashed var(--border-color);
        background: transparent;
        color: var(--text-color);
      }

      .btn-add:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
      }

      /* Report */
      #report-log {
        background-color: #11111b;
        padding: 20px;
        border-radius: 8px;
        font-family: "Consolas", "Monaco", monospace;
        white-space: pre-wrap;
        height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
      }

      .log-repo {
        color: var(--accent-color);
        font-weight: bold;
        font-size: 1.2em;
        margin-top: 25px;
        margin-bottom: 10px;
        display: block;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 5px;
      }

      .log-error {
        color: #f38ba8;
        margin-left: 15px;
        margin-bottom: 2px;
      }

      .log-info {
        color: #cdd6f4;
        margin-left: 15px;
        margin-bottom: 2px;
        line-height: 1.4;
      }

      .log-success {
        color: #a6e3a1;
        margin-left: 15px;
        font-weight: bold;
        margin-top: 5px;
      }

      .log-warning {
        color: #fab387; /* Peach/Orange */
        margin-left: 15px;
        margin-bottom: 2px;
      }

      .hidden {
        display: none;
      }

      #deprecation-log {
        background-color: #11111b;
        padding: 20px;
        border-radius: 8px;
        font-family: "Consolas", "Monaco", monospace;
        white-space: pre-wrap;
        height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
      }
      @media print {
        body {
          background-color: white;
          color: black;
          height: auto;
          overflow: visible;
        }
        .sidebar,
        .btn,
        .hint,
        #loading,
        .nav-item,
        .form-group,
        input,
        textarea,
        select {
          display: none !important;
        }
        .main-content {
          padding: 0;
          margin: 0;
          overflow: visible;
        }
        .tab-content {
          display: none; /* Hide all tabs by default */
        }
        #tab-report {
          display: block !important; /* Show only report */
          max-width: 100%;
        }

        /* Hide both columns by default in print */
        .report-container > div {
          display: none;
        }

        /* Reset container for print to avoid flexbox page break issues */
        .report-container {
          display: block !important;
          height: auto !important;
          overflow: visible !important;
        }

        /* Show Report Column - Portrait mode */
        @page report {
          size: portrait;
          margin: 1.5cm;
        }
        body.print-report {
          page: report;
        }
        body.print-report .report-container > div:first-child {
          display: block !important;
          width: 100% !important;
          height: auto !important;
          overflow: visible !important;
        }
        body.print-report #report-log {
          height: auto !important;
          max-height: none !important;
          border: none !important;
          background: #fff !important;
          padding: 0 !important;
          overflow: visible !important;
          font-family: "Segoe UI", Arial, sans-serif !important;
          font-size: 10pt !important;
        }
        body.print-report .log-repo {
          color: #000 !important;
          font-weight: bold !important;
          font-size: 12pt !important;
          border-bottom: 2px solid #333 !important;
          margin: 20px 0 10px 0 !important;
          padding-bottom: 5px !important;
        }
        body.print-report .log-info {
          color: #333 !important;
          margin-left: 15px !important;
          line-height: 1.6 !important;
        }
        body.print-report .log-success {
          color: #2d7d2d !important;
          margin-left: 15px !important;
          line-height: 1.6 !important;
        }
        body.print-report .log-error {
          color: #c00 !important;
          font-weight: bold !important;
          margin-left: 15px !important;
          line-height: 1.6 !important;
        }
        body.print-report .log-warning {
          color: #b45309 !important;
          margin-left: 15px !important;
          line-height: 1.6 !important;
        }

        /* Show Deprecation Column - Portrait mode */
        @page deprecation {
          size: portrait;
          margin: 1.5cm;
        }
        body.print-deprecation {
          page: deprecation;
        }
        body.print-deprecation .report-container > div:last-child {
          display: block !important;
          width: 100% !important;
          height: auto !important;
          overflow: visible !important;
        }
        body.print-deprecation #deprecation-log {
          height: auto !important;
          max-height: none !important;
          border: none !important;
          background: #fff !important;
          padding: 0 !important;
          overflow: visible !important;
          font-family: "Consolas", "Monaco", monospace !important;
          font-size: 9pt !important;
          white-space: pre-wrap !important;
        }
        body.print-deprecation .log-repo {
          color: #000 !important;
          font-weight: bold !important;
          font-size: 11pt !important;
          border-bottom: 2px solid #333 !important;
          margin: 20px 0 10px 0 !important;
          padding-bottom: 5px !important;
          font-family: "Segoe UI", Arial, sans-serif !important;
        }
        body.print-deprecation .log-warning {
          color: #000 !important;
          border-left: 3px solid #f59e0b !important;
          padding-left: 10px !important;
          margin: 8px 0 !important;
          line-height: 1.4 !important;
        }
        body.print-deprecation .log-info {
          color: #444 !important;
          line-height: 1.4 !important;
        }

        /* Show Migration Report - Landscape mode */
        @page migration {
          size: landscape;
          margin: 1cm;
        }
        body.print-migration {
          page: migration;
        }
        body.print-migration .main-content {
          display: block !important;
          padding: 0 !important;
          margin: 0 !important;
        }
        body.print-migration #tab-frameworks {
          display: block !important;
          padding: 0 !important;
        }
        /* Hide everything except the migration log content */
        body.print-migration .sidebar,
        body.print-migration #openrewrite-version-card,
        body.print-migration #tab-frameworks > h2,
        body.print-migration #spring-versions-container,
        body.print-migration #migration-analysis-section > h3,
        body.print-migration #migration-analysis-section > .form-group,
        body.print-migration #migration-progress,
        body.print-migration #migration-report-container > div:first-child {
          display: none !important;
        }
        /* Show only the migration log */
        body.print-migration #migration-report-container {
          display: block !important;
          padding: 0 !important;
        }
        body.print-migration #migration-log {
          height: auto !important;
          max-height: none !important;
          border: none !important;
          background: #fff !important;
          padding: 15px !important;
          margin: 0 !important;
          overflow: visible !important;
          box-sizing: border-box !important;
          width: 100% !important;
          font-family: "Segoe UI", Arial, sans-serif !important;
        }
        /* Style the HTML summary for print */
        body.print-migration .migration-summary {
          color: #000 !important;
        }
        body.print-migration .migration-summary h2 {
          color: #000 !important;
          border-bottom: 2px solid #333 !important;
          font-size: 18pt !important;
          display: block !important;
        }
        body.print-migration .migration-summary h3 {
          color: #333 !important;
          font-size: 12pt !important;
          margin: 15px 0 8px 0 !important;
          display: block !important;
        }
        body.print-migration .migration-summary table {
          width: 100% !important;
          border-collapse: collapse !important;
          font-size: 9pt !important;
        }
        body.print-migration .migration-summary tr {
          border-bottom: 1px solid #ddd !important;
        }
        body.print-migration .migration-summary td {
          padding: 4px 8px !important;
          color: #000 !important;
        }
        body.print-migration .migration-summary td:first-child {
          font-weight: bold !important;
          color: #444 !important;
        }
        body.print-migration .migration-summary span {
          background: #eee !important;
          color: #000 !important;
        }
        body.print-migration .migration-summary p {
          color: #000 !important;
        }
        body.print-migration .log-info,
        body.print-migration .log-success,
        body.print-migration .log-warning,
        body.print-migration .log-error {
          color: #000 !important;
          font-size: 10pt !important;
        }

        /* Common heading styles for print */
        h2,
        h3 {
          color: #000;
          border-bottom: 1px solid #333;
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="logo">üè† GitHousekeeper</div>
      <div class="nav-item active" onclick="showTab('settings')">
        Project Setup
      </div>
      <div class="nav-item" onclick="showTab('pom')">POM Replacements</div>
      <div class="nav-item" onclick="showTab('project')">
        Project Replacements
      </div>
      <div class="nav-item" onclick="showTab('report')">Report</div>
      <div class="nav-item" onclick="showTab('frameworks')">Frameworks</div>
      <div
        class="nav-item"
        onclick="showTab('about')"
        style="
          margin-top: 20px;
          border-top: 1px solid var(--border-color);
          padding-top: 15px;
        "
      >
        ‚ÑπÔ∏è About
      </div>

      <!-- Version Footer -->
      <div
        style="
          margin-top: auto;
          padding-top: 20px;
          font-size: 0.8em;
          color: #6c7086;
        "
      >
        <div>v1.0.0</div>
        <div style="margin-top: 5px">¬© 2025 GoreCode</div>
      </div>
    </div>

    <div class="main-content">
      <!-- Tab: Settings -->
      <div id="tab-settings" class="tab-content active">
        <h2>Project Setup</h2>
        <div class="form-group">
          <label>Project / Folder Path</label>
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="rootPath"
              placeholder="C:\Users\Name\Projects"
            />
            <button
              class="btn btn-secondary"
              onclick="pickFolder('rootPath')"
              title="Select Folder"
            >
              üìÇ
            </button>
          </div>
          <div class="hint">
            The root folder where Git repositories will be searched.
          </div>
        </div>
        <div class="form-group">
          <label>Included Projects (Uncheck to Exclude)</label>
          <div
            id="folder-list-container"
            style="
              max-height: 200px;
              overflow-y: auto;
              background: var(--input-bg);
              border: 1px solid var(--border-color);
              padding: 10px;
              border-radius: 6px;
            "
          >
            <div class="hint">Select a root path to see folders.</div>
          </div>
          <!-- Hidden input to store standard exclusions if needed, or we just handle it in JS -->
          <div class="hint">
            Uncheck folders to ignore them. Standard folders (node_modules,
            target, .git) are always ignored.
          </div>
        </div>
        <div class="form-group">
          <label>Branch Strategy</label>
          <div
            style="
              background-color: var(--input-bg);
              padding: 15px;
              border-radius: 6px;
              border: 1px solid var(--border-color);
            "
          >
            <div>
              <input
                type="radio"
                id="branch_none"
                name="branchStrategy"
                value="none"
                checked
                onchange="toggleBranchInput()"
              />
              <label
                for="branch_none"
                style="display: inline; font-weight: normal; margin-left: 5px"
                >No Branch (directly on Master)</label
              >
            </div>
            <div style="margin-bottom: 10px; margin-top: 10px">
              <input
                type="radio"
                id="branch_housekeeping"
                name="branchStrategy"
                value="housekeeping"
                onchange="toggleBranchInput()"
              />
              <label
                for="branch_housekeeping"
                style="display: inline; font-weight: normal; margin-left: 5px"
                >housekeeping (Default)</label
              >
            </div>
            <div style="display: flex; align-items: center">
              <input
                type="radio"
                id="branch_custom"
                name="branchStrategy"
                value="custom"
                onchange="toggleBranchInput()"
              />
              <input
                type="text"
                id="customBranchName"
                placeholder="Custom Branch Name"
                style="margin-left: 10px; width: 200px; padding: 5px"
                disabled
              />
            </div>
          </div>
          <div class="hint">Choose which branch to work on.</div>
        </div>

        <div class="form-group">
          <label>Parent Version (Optional)</label>
          <input type="text" id="parentVersion" placeholder="1.2.3" />
          <div class="hint">
            If specified, the parent version in pom.xml will be updated.
          </div>
        </div>
        <div class="form-group">
          <label>Version Bump (Microservice)</label>
          <select
            id="versionBumpStrategy"
            style="
              width: 100%;
              padding: 12px;
              background-color: var(--input-bg);
              border: 1px solid var(--border-color);
              border-radius: 6px;
              color: var(--text-color);
            "
          >
            <option value="patch">Patch (x.x.X) - Default</option>
            <option value="minor">Minor (x.X.0)</option>
            <option value="major">Major (X.0.0)</option>
          </select>
          <div class="hint">
            Determines which part of the version number is incremented (based on
            Git Tag).
          </div>
        </div>
        <div
          class="form-group"
          style="display: flex; align-items: center; gap: 10px"
        >
          <input type="checkbox" id="runCleanInstall" style="width: auto" />
          <label for="runCleanInstall" style="margin: 0; cursor: pointer"
            >Run Maven Clean Install</label
          >
        </div>
        <div class="hint" style="margin-top: -15px; margin-bottom: 20px">
          Runs 'mvn clean install -DskipTests' for each repository.
        </div>

        <div style="text-align: right; margin-top: 40px">
          <button class="btn btn-primary" onclick="showTab('pom')">
            Next &rarr;
          </button>
        </div>
      </div>

      <!-- Tab: POM Replacements -->
      <div id="tab-pom" class="tab-content">
        <h2>POM.xml Replacements</h2>
        <div id="pom-list">
          <div class="replacement-row">
            <textarea placeholder="Search Text" class="pom-search"></textarea>
            <textarea placeholder="Replacement" class="pom-replace"></textarea>
          </div>
        </div>
        <button class="btn btn-add" onclick="addRow('pom-list')">
          + Add Row
        </button>

        <div style="text-align: right; margin-top: 40px">
          <button class="btn btn-secondary" onclick="showTab('settings')">
            &larr; Back
          </button>
          <button class="btn btn-primary" onclick="showTab('project')">
            Next &rarr;
          </button>
        </div>
      </div>

      <!-- Tab: Project Replacements -->
      <div id="tab-project" class="tab-content">
        <h2>Project-wide Replacements</h2>
        <div class="hint" style="margin-bottom: 20px">
          These replacements will be performed in ALL files (except .git,
          target, etc.).
        </div>

        <div id="project-list">
          <div class="replacement-row">
            <textarea placeholder="Search Text" class="proj-search"></textarea>
            <textarea placeholder="Replacement" class="proj-replace"></textarea>
          </div>
        </div>
        <button class="btn btn-add" onclick="addRow('project-list')">
          + Add Row
        </button>

        <div style="text-align: right; margin-top: 40px">
          <button class="btn btn-secondary" onclick="showTab('pom')">
            &larr; Back
          </button>
          <button class="btn btn-primary" onclick="runHousekeeper()">
            üöÄ Start
          </button>
        </div>
      </div>

      <!-- Tab: Report -->
      <div id="tab-report" class="tab-content">
        <h2>Report</h2>

        <div class="report-container" style="display: flex; gap: 20px">
          <div style="flex: 1; width: 50%">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0">Log</h3>
              <button
                class="btn btn-secondary"
                style="padding: 5px 10px; font-size: 0.9em"
                onclick="printSection('report')"
              >
                üìÑ PDF
              </button>
            </div>
            <div id="report-log">
              <div class="log-info">Ready to start...</div>
            </div>
          </div>
          <div style="flex: 1; width: 50%">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0">Deprecation / Warnings</h3>
              <button
                class="btn btn-secondary"
                style="padding: 5px 10px; font-size: 0.9em"
                onclick="printSection('deprecation')"
              >
                üìÑ PDF
              </button>
            </div>
            <div id="deprecation-log">
              <div class="log-info">Waiting for results...</div>
            </div>
          </div>
        </div>
        <div
          id="loading"
          class="hidden"
          style="margin-top: 20px; color: var(--accent-color)"
        >
          Processing... Please wait.
        </div>
      </div>

      <!-- Tab: Frameworks -->
      <div id="tab-frameworks" class="tab-content">
        <!-- OpenRewrite Version Check -->
        <div
          id="openrewrite-version-card"
          style="
            background: var(--input-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <h3 style="margin: 0">üîß OpenRewrite Status</h3>
            <button
              class="btn btn-secondary"
              onclick="checkOpenRewriteVersions()"
              style="font-size: 0.85rem; padding: 5px 10px"
            >
              üîÑ Refresh
            </button>
          </div>
          <div
            id="openrewrite-versions"
            style="display: flex; gap: 20px; flex-wrap: wrap"
          >
            <div class="hint">Loading OpenRewrite versions...</div>
          </div>
        </div>

        <h2>Spring Boot Versions</h2>

        <div id="spring-versions-container" style="display: flex; gap: 20px">
          <!-- Left: Available Versions -->
          <div style="flex: 1">
            <h3>Available Versions</h3>
            <div id="spring-versions-list">
              <div class="log-info">Loading versions...</div>
            </div>
          </div>

          <!-- Right: Local Projects -->
          <div style="flex: 1">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin: 0">Local Projects</h3>
              <button class="btn btn-secondary" onclick="scanSpringProjects()">
                üîç Scan
              </button>
            </div>
            <div
              id="spring-projects-list"
              style="margin-top: 10px; margin-bottom: 30px"
            >
              <div class="hint">Click Scan to check local versions.</div>
            </div>
          </div>
        </div>

        <!-- Migration Analysis - Moved outside the flex container for better print isolation -->
        <div
          id="migration-analysis-section"
          style="
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            margin-top: 20px;
          "
        >
          <h3 style="margin-top: 0">Migration Analysis (OpenRewrite)</h3>
          <div class="form-group">
            <label>Target Spring Boot Version</label>
            <div style="display: flex; gap: 10px">
              <select id="targetBootVersion">
                <option value="">Select Version...</option>
              </select>
              <button
                class="btn btn-primary"
                onclick="runOpenRewriteAnalysis()"
              >
                üìä Analyze
              </button>
            </div>
            <div class="hint">
              Runs OpenRewrite in dry-run mode to detect necessary changes. No
              files will be modified.
            </div>
          </div>

          <div id="migration-report-container" class="hidden">
            <!-- Progress Bar -->
            <div
              id="migration-progress"
              class="hidden"
              style="margin-bottom: 20px"
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 5px;
                "
              >
                <span id="progress-text">Analyzing... 0/0</span>
                <span id="progress-eta">Estimated: calculating...</span>
              </div>
              <div
                style="
                  background-color: var(--input-bg);
                  border-radius: 10px;
                  height: 20px;
                  overflow: hidden;
                "
              >
                <div
                  id="progress-bar"
                  style="
                    background: linear-gradient(
                      90deg,
                      var(--accent-color),
                      var(--accent-hover)
                    );
                    height: 100%;
                    width: 0%;
                    transition: width 0.3s ease;
                    border-radius: 10px;
                  "
                ></div>
              </div>
              <div style="text-align: center; margin-top: 5px">
                <span
                  id="progress-percent"
                  style="
                    font-size: 1.2em;
                    font-weight: bold;
                    color: var(--accent-color);
                  "
                  >0%</span
                >
              </div>
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <h4>Analysis Report</h4>
              <button
                class="btn btn-secondary"
                onclick="printSection('migration')"
              >
                üñ®Ô∏è PDF / Print
              </button>
            </div>
            <div
              id="migration-log"
              style="
                background-color: #11111b;
                padding: 20px;
                border-radius: 8px;
                font-family: 'Consolas', monospace;
                white-space: pre-wrap;
                height: 300px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
              "
            ></div>
          </div>
        </div>
      </div>

      <!-- Tab: About -->
      <div id="tab-about" class="tab-content">
        <h2>About GitHousekeeper</h2>

        <div style="max-width: 800px">
          <!-- App Info Card -->
          <div
            style="
              background-color: var(--input-bg);
              border-radius: 12px;
              padding: 30px;
              margin-bottom: 30px;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 20px;
                margin-bottom: 20px;
              "
            >
              <div style="font-size: 48px">üè†</div>
              <div>
                <h3
                  style="
                    margin: 0;
                    color: var(--accent-color);
                    font-size: 1.8em;
                  "
                >
                  GitHousekeeper
                </h3>
                <div style="color: #a6adc8; margin-top: 5px">Version 1.0.0</div>
              </div>
            </div>
            <p style="line-height: 1.6; color: #a6adc8">
              A powerful tool for automating maintenance tasks and
              mass-refactoring across multiple Git repositories. Built for
              developers who manage multiple Spring Boot microservices.
            </p>
          </div>

          <!-- Features Summary -->
          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 15px;
              margin-bottom: 30px;
            "
          >
            <div
              style="
                background-color: var(--sidebar-color);
                border-radius: 8px;
                padding: 15px;
                border: 1px solid var(--border-color);
              "
            >
              <div style="font-size: 24px; margin-bottom: 8px">üîç</div>
              <div style="font-weight: bold; margin-bottom: 5px">
                Multi-Repo Management
              </div>
              <div style="font-size: 0.85em; color: #a6adc8">
                Auto-discover and batch process repositories
              </div>
            </div>
            <div
              style="
                background-color: var(--sidebar-color);
                border-radius: 8px;
                padding: 15px;
                border: 1px solid var(--border-color);
              "
            >
              <div style="font-size: 24px; margin-bottom: 8px">üçÉ</div>
              <div style="font-weight: bold; margin-bottom: 5px">
                Spring Boot Analysis
              </div>
              <div style="font-size: 0.85em; color: #a6adc8">
                OpenRewrite-powered migration insights
              </div>
            </div>
            <div
              style="
                background-color: var(--sidebar-color);
                border-radius: 8px;
                padding: 15px;
                border: 1px solid var(--border-color);
              "
            >
              <div style="font-size: 24px; margin-bottom: 8px">üîÑ</div>
              <div style="font-weight: bold; margin-bottom: 5px">
                Mass Refactoring
              </div>
              <div style="font-size: 0.85em; color: #a6adc8">
                Search & replace across all projects
              </div>
            </div>
            <div
              style="
                background-color: var(--sidebar-color);
                border-radius: 8px;
                padding: 15px;
                border: 1px solid var(--border-color);
              "
            >
              <div style="font-size: 24px; margin-bottom: 8px">üè∑Ô∏è</div>
              <div style="font-weight: bold; margin-bottom: 5px">
                Version Automation
              </div>
              <div style="font-size: 0.85em; color: #a6adc8">
                Git tags & pom.xml updates
              </div>
            </div>
          </div>

          <!-- Author & Links -->
          <div
            style="
              background-color: var(--input-bg);
              border-radius: 12px;
              padding: 25px;
            "
          >
            <h4 style="margin-top: 0; margin-bottom: 15px">Created by</h4>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 20px;
              "
            >
              <div
                style="
                  width: 50px;
                  height: 50px;
                  background: linear-gradient(
                    135deg,
                    var(--accent-color),
                    var(--accent-hover)
                  );
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 24px;
                  font-weight: bold;
                  color: var(--sidebar-color);
                "
              >
                G
              </div>
              <div>
                <div style="font-weight: bold; font-size: 1.2em">GoreCode</div>
                <div style="color: #a6adc8">Open Source Developer</div>
              </div>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap">
              <a
                href="https://github.com/gorecodecom/GitHousekeeper"
                target="_blank"
                style="
                  display: inline-flex;
                  align-items: center;
                  gap: 8px;
                  padding: 10px 16px;
                  background-color: var(--sidebar-color);
                  border-radius: 6px;
                  color: var(--text-color);
                  text-decoration: none;
                  border: 1px solid var(--border-color);
                "
              >
                ‚≠ê GitHub Repository
              </a>
              <a
                href="https://github.com/gorecodecom/GitHousekeeper/issues"
                target="_blank"
                style="
                  display: inline-flex;
                  align-items: center;
                  gap: 8px;
                  padding: 10px 16px;
                  background-color: var(--sidebar-color);
                  border-radius: 6px;
                  color: var(--text-color);
                  text-decoration: none;
                  border: 1px solid var(--border-color);
                "
              >
                üêõ Report Issue
              </a>
              <a
                href="https://github.com/gorecodecom"
                target="_blank"
                style="
                  display: inline-flex;
                  align-items: center;
                  gap: 8px;
                  padding: 10px 16px;
                  background-color: var(--sidebar-color);
                  border-radius: 6px;
                  color: var(--text-color);
                  text-decoration: none;
                  border: 1px solid var(--border-color);
                "
              >
                üë§ More Projects
              </a>
            </div>
          </div>

          <!-- License -->
          <div
            style="
              margin-top: 30px;
              text-align: center;
              color: #6c7086;
              font-size: 0.9em;
            "
          >
            <p>Released under the MIT License</p>
            <p>¬© 2025 GoreCode</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      function showTab(tabId) {
        // Update Sidebar
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelector(`.nav-item[onclick="showTab('${tabId}')"]`)
          .classList.add("active");

        // Update Content
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(`tab-${tabId}`).classList.add("active");

        if (tabId === "frameworks") {
          loadSpringVersions();
          checkOpenRewriteVersions();
        }
      }

      function toggleBranchInput() {
        const isCustom = document.getElementById("branch_custom").checked;
        const input = document.getElementById("customBranchName");
        input.disabled = !isCustom;
        if (isCustom) input.focus();
      }

      function addRow(containerId) {
        const container = document.getElementById(containerId);
        const div = document.createElement("div");
        div.className = "replacement-row";
        div.innerHTML = `
            <textarea placeholder="Search Text" class="${
              containerId === "pom-list" ? "pom-search" : "proj-search"
            }"></textarea>
            <textarea placeholder="Replacement" class="${
              containerId === "pom-list" ? "pom-replace" : "proj-replace"
            }"></textarea>
        `;
        container.appendChild(div);
      }

      function printSection(section) {
        document.body.classList.add("print-" + section);
        window.print();
        document.body.classList.remove("print-" + section);
      }

      async function runHousekeeper() {
        showTab("report");
        const log = document.getElementById("report-log");
        const deprecationLog = document.getElementById("deprecation-log");
        const loading = document.getElementById("loading");

        log.innerHTML = "";
        deprecationLog.innerHTML = "";
        loading.classList.remove("hidden");

        // Determine Target Branch
        let targetBranch = "";
        if (document.getElementById("branch_housekeeping").checked) {
          targetBranch = "housekeeping";
        } else if (document.getElementById("branch_custom").checked) {
          targetBranch = document
            .getElementById("customBranchName")
            .value.trim();
          if (!targetBranch) {
            alert("Please enter a branch name.");
            loading.classList.add("hidden");
            return;
          }
        } else {
          // None selected -> Master
          targetBranch = "";
        }

        // Collect Data
        // Calculate Excluded Folders from Checkboxes
        const excluded = [
          "node_modules",
          "target",
          "dist",
          ".git",
          ".idea",
          ".vscode",
        ]; // Standard defaults
        document
          .querySelectorAll('#folder-list-container input[type="checkbox"]')
          .forEach((cb) => {
            if (!cb.checked) {
              excluded.push(cb.value);
            }
          });

        const data = {
          rootPath: document.getElementById("rootPath").value,
          excluded: excluded,
          parentVersion: document.getElementById("parentVersion").value,
          versionBumpStrategy: document.getElementById("versionBumpStrategy")
            .value,
          runCleanInstall: document.getElementById("runCleanInstall").checked,
          targetBranch: targetBranch,
          pomReplacements: [],
          projectReplacements: [],
        };

        if (!data.rootPath) {
          alert("Please specify a project path.");
          loading.classList.add("hidden");
          showTab("settings");
          return;
        }

        // Save settings to localStorage
        localStorage.setItem(
          "gitHousekeeper_settings",
          JSON.stringify({
            rootPath: data.rootPath,
            // excluded: document.getElementById('excluded').value, // No longer saving excluded list as text
            parentVersion: data.parentVersion,
            versionBumpStrategy: data.versionBumpStrategy,
            runCleanInstall: data.runCleanInstall,
            branchStrategy: document.querySelector(
              'input[name="branchStrategy"]:checked'
            ).value,
            customBranchName: document.getElementById("customBranchName").value,
          })
        );

        // Collect POM
        document
          .querySelectorAll("#pom-list .replacement-row")
          .forEach((row) => {
            const search = row.querySelector(".pom-search").value;
            const replace = row.querySelector(".pom-replace").value;
            if (search) {
              data.pomReplacements.push({ Search: search, Replace: replace });
            }
          });

        // Collect Project
        document
          .querySelectorAll("#project-list .replacement-row")
          .forEach((row) => {
            const search = row.querySelector(".proj-search").value;
            const replace = row.querySelector(".proj-replace").value;
            if (search) {
              data.projectReplacements.push({
                Search: search,
                Replace: replace,
              });
            }
          });

        try {
          const response = await fetch("/api/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let isDeprecation = false;

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split("\n");

            for (let line of lines) {
              if (!line.trim()) continue;

              if (line.startsWith("DEPRECATION_START:")) {
                isDeprecation = true;
                const repoName = line.split(":")[1];
                const header = document.createElement("div");
                header.className = "log-repo";
                header.textContent = repoName;
                deprecationLog.appendChild(header);
                continue;
              }
              if (line.startsWith("DEPRECATION_END")) {
                isDeprecation = false;
                continue;
              }

              if (isDeprecation) {
                const div = document.createElement("div");
                div.className = "log-warning";
                div.textContent = line;
                deprecationLog.appendChild(div);
                deprecationLog.scrollTop = deprecationLog.scrollHeight;
                continue;
              }

              const div = document.createElement("div");
              if (line.startsWith("REPO:")) {
                div.className = "log-repo";
                div.textContent = line.substring(5);
              } else if (line.includes("[FEHLER]") || line.includes("‚úó")) {
                div.className = "log-error";
                div.textContent = line;
              } else if (
                line.includes("[WARNUNG]") ||
                line.toLowerCase().includes("warning") ||
                line.toLowerCase().includes("deprecated")
              ) {
                div.className = "log-warning";
                div.textContent = line;
              } else if (line.includes("‚úì") || line.includes("erfolgreich")) {
                div.className = "log-success";
                div.textContent = line;
              } else {
                div.className = "log-info";
                div.textContent = line;
              }
              log.appendChild(div);
              log.scrollTop = log.scrollHeight;
            }
          }
        } catch (e) {
          log.innerHTML += `<div class="log-error">Error: ${e.message}</div>`;
        } finally {
          loading.classList.add("hidden");
          log.innerHTML +=
            '<div class="log-info" style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">--- Done ---</div>';
        }
      }

      // Load settings on startup
      window.addEventListener("DOMContentLoaded", () => {
        const saved = localStorage.getItem("gitHousekeeper_settings");
        if (saved) {
          try {
            const settings = JSON.parse(saved);
            if (settings.rootPath) {
              document.getElementById("rootPath").value = settings.rootPath;
              loadFolders(); // Trigger load
            }
            // if (settings.excluded) document.getElementById('excluded').value = settings.excluded;
            if (settings.parentVersion)
              document.getElementById("parentVersion").value =
                settings.parentVersion;
            if (settings.versionBumpStrategy)
              document.getElementById("versionBumpStrategy").value =
                settings.versionBumpStrategy;
            if (settings.runCleanInstall !== undefined)
              document.getElementById("runCleanInstall").checked =
                settings.runCleanInstall;

            if (settings.branchStrategy) {
              const rb = document.querySelector(
                `input[name="branchStrategy"][value="${settings.branchStrategy}"]`
              );
              if (rb) rb.checked = true;
            }
            if (settings.customBranchName)
              document.getElementById("customBranchName").value =
                settings.customBranchName;
            toggleBranchInput();
          } catch (e) {
            console.error("Failed to load settings", e);
          }
        }

        // Auto-load folders when typing/pasting path
        const rootPathInput = document.getElementById("rootPath");
        let debounceTimer;
        rootPathInput.addEventListener("input", () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            loadFolders();
          }, 500);
        });
      });

      // Folder Picker Logic
      async function pickFolder(targetId) {
        // Feature detection for File System Access API
        if ("showDirectoryPicker" in window) {
          try {
            const handle = await window.showDirectoryPicker();
            // Note: The API does NOT expose the full absolute path for security reasons.
            // It only gives the directory name.
            // However, for a local tool, users expect to pick a path.
            // Since we can't get the path, we have to inform the user.
            alert(
              "Note: Browser security policies prevent reading the full path. Please copy the path manually from Explorer."
            );
          } catch (e) {
            // User cancelled or error
            console.log(e);
          }
        } else {
          alert(
            "Your browser does not support folder selection. Please copy the path manually."
          );
        }
      }

      async function loadSpringVersions() {
        const container = document.getElementById("spring-versions-list");
        // Avoid reloading if already loaded? Maybe not, to get fresh data.

        try {
          const res = await fetch("/api/spring-versions");
          if (!res.ok) throw new Error(res.statusText);
          const data = await res.json();

          container.innerHTML = "";

          // Show only first 5 branches initially
          const initialShowCount = 5;
          let hiddenContainer = null;
          let showMoreBtn = null;

          data.forEach((group, index) => {
            const groupDiv = document.createElement("div");
            groupDiv.style.marginBottom = "20px";
            groupDiv.style.padding = "15px";
            groupDiv.style.backgroundColor = "var(--input-bg)";
            groupDiv.style.borderRadius = "6px";

            const title = document.createElement("h4");
            title.style.margin = "0 0 10px 0";
            title.style.color = "var(--accent-color)";
            title.textContent = `Spring Boot ${group.Branch}`;

            if (group.MigrationGuide) {
              const link = document.createElement("a");
              link.href = group.MigrationGuide;
              link.target = "_blank";
              link.style.fontSize = "0.8em";
              link.style.marginLeft = "10px";
              link.style.color = "#89b4fa";
              link.textContent = group.Branch.endsWith(".0")
                ? "üìñ Migration Guide"
                : "üìù Release Notes";
              title.appendChild(link);
            }

            groupDiv.appendChild(title);

            // Add to Dropdown (always add all versions to dropdown)
            const dropdown = document.getElementById("targetBootVersion");
            // Check if option already exists
            if (!dropdown.querySelector(`option[value="${group.Branch}"]`)) {
              const option = document.createElement("option");
              option.value = group.Branch;
              // Show latest version in label
              const latest = group.Versions.length > 0 ? group.Versions[0] : "";
              option.textContent = `Spring Boot ${group.Branch} (Latest: ${latest})`;
              dropdown.appendChild(option);
            }

            const versionsDiv = document.createElement("div");
            versionsDiv.style.fontSize = "0.9em";
            versionsDiv.style.color = "#a6adc8";
            // Show top 5 versions, then "..."
            const showCount = 5;
            const visible = group.Versions.slice(0, showCount);
            versionsDiv.textContent = visible.join(", ");

            if (group.Versions.length > showCount) {
              const more = document.createElement("span");
              more.textContent = ` (+${
                group.Versions.length - showCount
              } weitere)`;
              more.style.cursor = "pointer";
              more.style.textDecoration = "underline";
              more.style.marginLeft = "5px";
              more.onclick = () => {
                versionsDiv.textContent = group.Versions.join(", ");
              };
              versionsDiv.appendChild(more);
            }

            groupDiv.appendChild(versionsDiv);

            // Add to visible container or hidden container based on index
            if (index < initialShowCount) {
              container.appendChild(groupDiv);
            } else {
              // Create hidden container if not exists
              if (!hiddenContainer) {
                hiddenContainer = document.createElement("div");
                hiddenContainer.id = "hidden-versions";
                hiddenContainer.style.display = "none";
                container.appendChild(hiddenContainer);
              }
              hiddenContainer.appendChild(groupDiv);
            }
          });

          // Add "Show More" button if there are hidden items
          if (data.length > initialShowCount) {
            showMoreBtn = document.createElement("button");
            showMoreBtn.className = "btn btn-secondary";
            showMoreBtn.style.width = "100%";
            showMoreBtn.style.marginTop = "10px";
            showMoreBtn.innerHTML = `üìã √Ñltere Versionen anzeigen (+${
              data.length - initialShowCount
            })`;
            showMoreBtn.onclick = () => {
              const hidden = document.getElementById("hidden-versions");
              if (hidden.style.display === "none") {
                hidden.style.display = "block";
                showMoreBtn.innerHTML = "üìã √Ñltere Versionen ausblenden";
              } else {
                hidden.style.display = "none";
                showMoreBtn.innerHTML = `üìã √Ñltere Versionen anzeigen (+${
                  data.length - initialShowCount
                })`;
              }
            };
            container.appendChild(showMoreBtn);
          }
        } catch (e) {
          container.innerHTML = `<div class="log-error">Error loading: ${e.message}</div>`;
        }
      }

      async function checkOpenRewriteVersions() {
        const container = document.getElementById("openrewrite-versions");

        try {
          const res = await fetch("/api/openrewrite-versions");
          if (!res.ok) throw new Error(res.statusText);
          const data = await res.json();

          container.innerHTML = "";

          data.forEach((item) => {
            const card = document.createElement("div");
            card.style.cssText =
              "flex: 1; min-width: 200px; padding: 12px; background: var(--bg-color); border-radius: 6px; border: 1px solid var(--border-color);";

            const hasUpdate = item.updateAvailable;
            const statusColor = hasUpdate ? "#f9e2af" : "#a6e3a1";
            const statusIcon = hasUpdate ? "‚ö†Ô∏è" : "‚úÖ";
            const statusText = hasUpdate ? "Update verf√ºgbar" : "Aktuell";

            card.innerHTML = `
              <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-color);">
                ${item.component}
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 4px;">
                <span style="color: #6c7086;">Verwendet:</span>
                <span style="color: var(--text-color); font-family: monospace;">${
                  item.currentVersion
                }</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 8px;">
                <span style="color: #6c7086;">Aktuell:</span>
                <span style="color: ${
                  hasUpdate ? "#a6e3a1" : "var(--text-color)"
                }; font-family: monospace;">${item.latestVersion}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: ${statusColor}; font-size: 0.85em;">${statusIcon} ${statusText}</span>
                <a href="${
                  item.mavenCentralUrl
                }" target="_blank" style="color: #89b4fa; font-size: 0.85em; text-decoration: none;">
                  Maven Central ‚Üó
                </a>
              </div>
            `;

            container.appendChild(card);
          });
        } catch (e) {
          container.innerHTML = `<div class="log-error">Fehler: ${e.message}</div>`;
        }
      }

      async function scanSpringProjects() {
        const container = document.getElementById("spring-projects-list");
        const rootPath = document.getElementById("rootPath").value;

        // Calculate Excluded Folders from Checkboxes
        const excluded = [
          "node_modules",
          "target",
          "dist",
          ".git",
          ".idea",
          ".vscode",
        ]; // Standard defaults
        document
          .querySelectorAll('#folder-list-container input[type="checkbox"]')
          .forEach((cb) => {
            if (!cb.checked) {
              excluded.push(cb.value);
            }
          });

        if (!rootPath) {
          alert("Please configure the project path in Project Setup first.");
          return;
        }

        container.innerHTML = '<div class="log-info">Scanning...</div>';

        try {
          const res = await fetch("/api/scan-spring", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ RootPath: rootPath, Excluded: excluded }),
          });
          if (!res.ok) throw new Error(res.statusText);
          const results = await res.json();

          container.innerHTML = "";

          // Handle new SpringScanResult structure
          if (!results || !results.Projects || results.Projects.length === 0) {
            let html = '<div class="hint">No Spring Boot projects found.</div>';

            // Show debug log if available
            if (results && results.DebugLog && results.DebugLog.length > 0) {
              html +=
                '<div style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:10px;">';
              html += "<h4>Debug Log</h4>";
              html +=
                '<div style="font-family:monospace; font-size:0.8em; color:#a6adc8; max-height:200px; overflow-y:auto;">';
              results.DebugLog.forEach((line) => {
                html += `<div>${line}</div>`;
              });
              html += "</div></div>";
            }

            container.innerHTML = html;
            return;
          }

          // Display found projects
          results.Projects.forEach((proj) => {
            const div = document.createElement("div");
            div.style.padding = "10px";
            div.style.borderBottom = "1px solid var(--border-color)";

            div.innerHTML = `
                    <div style="font-weight:bold;">${proj.RepoName}</div>
                    <div style="font-size:0.9em; color: #a6adc8;">Aktuell: <span style="color: var(--accent-color);">${proj.CurrentVersion}</span></div>
                `;
            container.appendChild(div);
          });
        } catch (e) {
          container.innerHTML = `<div class="log-error">Error scanning: ${e.message}</div>`;
        }
      }

      // Folder Picker: Call backend API to open native OS dialog
      async function pickFolder(targetId) {
        try {
          const res = await fetch("/api/pick-folder");
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text);
          }
          const data = await res.json();
          if (data.path) {
            document.getElementById(targetId).value = data.path;
            if (targetId === "rootPath") {
              loadFolders();
            }
          }
        } catch (e) {
          console.error(e);
          alert("Error opening dialog: " + e.message);
        }
      }

      async function loadFolders() {
        const rootPath = document.getElementById("rootPath").value;
        const container = document.getElementById("folder-list-container");

        if (!rootPath) {
          container.innerHTML = "";
          return;
        }

        container.innerHTML = '<div class="log-info">Loading folders...</div>';

        try {
          const res = await fetch("/api/list-folders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ Path: rootPath }),
          });

          if (!res.ok) throw new Error(res.statusText);
          const data = await res.json();

          container.innerHTML = "";

          if (data.Error) {
            container.innerHTML = `<div class="log-error">${data.Error}</div>`;
            return;
          }

          if (data.IsRepo) {
            container.innerHTML =
              '<div class="hint">None (Current folder is a Git Repository)</div>';
            return;
          }

          if (!data.Folders || data.Folders.length === 0) {
            container.innerHTML =
              '<div class="hint">No subfolders found.</div>';
            return;
          }

          // Filter out standard junk from display to keep it clean?
          // Or just show everything? User said "Auflistung der Ordner".
          // Usually we don't want to see .git or node_modules in this list if we are selecting projects.
          const ignoreDisplay = [
            ".git",
            "node_modules",
            "target",
            "dist",
            ".idea",
            ".vscode",
          ];

          data.Folders.forEach((folder) => {
            if (ignoreDisplay.includes(folder)) return;

            const div = document.createElement("div");
            div.style.marginBottom = "5px";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = "folder_" + folder;
            checkbox.value = folder;
            checkbox.checked = true; // Default checked
            checkbox.style.width = "auto";
            checkbox.style.marginRight = "10px";

            const label = document.createElement("label");
            label.htmlFor = "folder_" + folder;
            label.textContent = folder;
            label.style.display = "inline";
            label.style.fontWeight = "normal";

            div.appendChild(checkbox);
            div.appendChild(label);
            container.appendChild(div);
          });

          if (container.children.length === 0) {
            container.innerHTML =
              '<div class="hint">No relevant subfolders found.</div>';
          }
        } catch (e) {
          container.innerHTML = `<div class="log-error">Error loading folders: ${e.message}</div>`;
        }
      }

      async function runOpenRewriteAnalysis() {
        const rootPath = document.getElementById("rootPath").value;
        const targetVersion =
          document.getElementById("targetBootVersion").value;
        const container = document.getElementById("migration-report-container");
        const log = document.getElementById("migration-log");
        const progressContainer = document.getElementById("migration-progress");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        const progressEta = document.getElementById("progress-eta");
        const progressPercent = document.getElementById("progress-percent");

        // Get excluded folders
        const excluded = [
          "node_modules",
          "target",
          "dist",
          ".git",
          ".idea",
          ".vscode",
        ];
        document
          .querySelectorAll('#folder-list-container input[type="checkbox"]')
          .forEach((cb) => {
            if (!cb.checked) {
              excluded.push(cb.value);
            }
          });

        if (!rootPath) {
          alert("Please configure the project path first.");
          return;
        }
        if (!targetVersion) {
          alert("Please select a target version.");
          return;
        }

        container.classList.remove("hidden");
        progressContainer.classList.add("hidden");
        log.innerHTML =
          '<div class="log-info">Starting OpenRewrite analysis... This may take a while.</div>';

        let totalProjects = 0;

        try {
          const res = await fetch("/api/analyze-spring", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              RootPath: rootPath,
              Excluded: excluded,
              TargetVersion: targetVersion,
            }),
          });

          const reader = res.body.getReader();
          const decoder = new TextDecoder("utf-8");

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split("\n");

            for (let line of lines) {
              if (!line.trim()) continue;

              // Handle progress markers
              if (line.startsWith("PROGRESS_INIT:")) {
                totalProjects = parseInt(line.split(":")[1]);
                progressContainer.classList.remove("hidden");
                progressBar.style.width = "0%";
                progressText.textContent = `Analyzing... 0/${totalProjects}`;
                progressEta.textContent = "Estimated: calculating...";
                progressPercent.textContent = "0%";
                continue;
              }

              if (line.startsWith("PROGRESS_UPDATE:")) {
                const parts = line.split(":");
                const completed = parseInt(parts[1]);
                const total = parseInt(parts[2]);
                const remainingSecs = parseFloat(parts[3]);

                const percent = Math.round((completed / total) * 100);
                progressBar.style.width = percent + "%";
                progressText.textContent = `Analyzing... ${completed}/${total}`;
                progressPercent.textContent = percent + "%";

                if (remainingSecs > 0) {
                  const mins = Math.floor(remainingSecs / 60);
                  const secs = Math.round(remainingSecs % 60);
                  if (mins > 0) {
                    progressEta.textContent = `Estimated: ~${mins}m ${secs}s remaining`;
                  } else {
                    progressEta.textContent = `Estimated: ~${secs}s remaining`;
                  }
                } else {
                  progressEta.textContent = "Finishing...";
                }
                continue;
              }

              if (line.startsWith("PROGRESS_DONE:")) {
                const totalSecs = parseFloat(line.split(":")[1]);
                const mins = Math.floor(totalSecs / 60);
                const secs = Math.round(totalSecs % 60);
                progressBar.style.width = "100%";
                progressPercent.textContent = "100%";
                progressText.textContent = `Completed ${totalProjects}/${totalProjects}`;
                if (mins > 0) {
                  progressEta.textContent = `Total time: ${mins}m ${secs}s`;
                } else {
                  progressEta.textContent = `Total time: ${secs}s`;
                }
                continue;
              }

              // Check if line contains HTML (from migration summary)
              if (
                line.includes('<div class="migration-summary">') ||
                line.includes('<div class="summary-section">') ||
                line.includes("</div>")
              ) {
                // Render HTML directly
                log.innerHTML += line;
                log.scrollTop = log.scrollHeight;
                continue;
              }

              // Regular log output - escape HTML
              const formattedLine = line
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

              // Color coding
              let cssClass = "log-info";
              if (line.includes("‚úó") || line.toLowerCase().includes("error")) {
                cssClass = "log-error";
              } else if (line.includes("‚úì") || line.includes(">>>")) {
                cssClass = "log-success";
              } else if (line.includes("Changes detected")) {
                cssClass = "log-warning";
              }

              log.innerHTML += `<div class="${cssClass}">${formattedLine}</div>`;
              log.scrollTop = log.scrollHeight;
            }
          }

          log.innerHTML +=
            '<div class="log-success" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">--- Analysis Complete ---</div>';
        } catch (e) {
          log.innerHTML += `<div class="log-error">Error: ${e.message}</div>`;
          progressContainer.classList.add("hidden");
        }
      }
    </script>
  </body>
</html>
